name: Release
description: Create zip & 7z assets, push them in release and archive them when a new tag is created

on:
  push:
    tags:
      - 'v*'
jobs:
  runs-on: ubuntu-latest
  permissions:
    contents: write
    strategy:
      matrix:
        compress_format: ['zip', '7z']

  compress_and_push_mods_versionned_assets:
    strategy:
      matrix:
        mod_version: ['1.0.0', '1.1.0', '1.1.1', '1.1.2']
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Set up zip
        run: |
          sudo chmod +x zip_script.sh
          ./zip_script.sh ${{ matrix.mod_version }} Mods/ ${{ matrix.compress_format }}
      - name: Push the assets
        uses: softprops/action-gh-release@v1
        with:
          files: Releases/${{ matrix.mod_version }.${{ matrix.compress_format }}

  compress_and_push_mods_assets:
    - name: Checkout code
      uses: actions/checkout@v3
    - name: ${{ matrix.compress_format }} mods
      run: 7z a -t${{ matrix.compress_format }} -mx9 ./Releases/TOTK-Mods-collection.${{ matrix.compress_format }} -x!'./.git/' -x!'./Releases/' -x!'./.github/' -x!'./config.yaml' ./
    - name: Switching from HTTPS to SSH
      run: git remote set-url origin ${{ secrets.ssh_url }}
    - name: Stage changed files
      run: |
        git status
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add Releases/
        git commit -a -m "Pushing new release ${{ github.ref_name }}"
    - name: Push changes on main âœ¨
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: main